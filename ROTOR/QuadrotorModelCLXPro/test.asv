%% testy mctestface
close all
clear all
clc
initial_conditions
LoadQuadrotorConst_XPro1a

A = [0 1 0 0 0 0 0 0 0 0 0 0;
0 0 0 0 0 0 0 0 9.8089 0 0 0;
0 0 0 1 0 0 0 0 0 0 0 0;
0 0 0 0 0 0 -9.8089 0 0 0 0 0;
0 0 0 0 0 1 0 0 0 0 0 0;
0 0 0 0 0 0 0 0 0 0 0 0;
0 0 0 0 0 0 0 1 0 0 0 0;
0 0 0 0 0 0 0 0 0 0 0 0;
0 0 0 0 0 0 0 0 0 1 0 0;
0 0 0 0 0 0 0 0 0 0 0 0;
0 0 0 0 0 0 0 0 0 0 0 1;
0 0 0 0 0 0 0 0 0 0 0 0]


B =[0 0 0 0;
0 0 0 0;
0 0 0 0;
0 0 0 0;
0 0 0 0;
0.001119 0.001119 0.001119 0.001119;
0 0 0 0;
0 0.008234 0 -0.008234;
0 0 0 0;
-0.008234 0 0.008234 0;
0 0 0 0;
-0.005615 0.005615 -0.005615 0.005615]

C = eye(12);
[K,S,E] = lqr(A,B,200*eye(12),0.1*eye(4))
Xref = [0 0 0 0 30 0 0 0 0 0 0 0]';

%%
T = linspace(0,100,1001)';
% 0.5*V1_WP.*cos(linspace(0,2*pi*30,1001))'
V1 = [T zeros(1001,1)];
V2 = [T zeros(1001,1)];
V3 = [T zeros(1001,1)];
V4 = [T zeros(1001,1)];
Vin = [V1 V2 V3 V4];

tic
sim('CL_Xpro_model');
toc

figure; subplot(3,1,1)
plot(state.Time, state.Data(:,1)); title('x vs time')
subplot(3,1,2)
plot(state.Time, state.Data(:,3)); title('y vs time')
subplot(3,1,3)
plot(state.Time, state.Data(:,5)); title('z vs time')

figure; subplot(3,1,1)
plot(state.Time, state.Data(:,7)); title('Phi vs time')
subplot(3,1,2)
plot(state.Time, state.Data(:,9)); title('Theta vs time')
subplot(3,1,3)
plot(state.Time, state.Data(:,11)); title('Psi vs time')

figure; hold on;
grid on;
plot3(state.Data(:,1), state.Data(:,3), state.Data(:,5));
title('Trajectory');
xlabel('X distance (m)')
ylabel('Y distance (m)')
zlabel('Z distance (m)')

figure; 
plot(rotorspeed.Time, rotorspeed.Data);hold on;
title('rotorspeed vs time')

figure; subplot(4,1,1)
plot(voltages.Time, voltages.Data(:,1));
subplot(4,1,2)
plot(voltages.Time, voltages.Data(:,2));
subplot(4,1,3)
plot(voltages.Time, voltages.Data(:,3));
subplot(4,1,4)
plot(voltages.Time, voltages.Data(:,4));
 title('Voltages!')
 legend('v1', '')
%new stuff

figure; subplot(4,1,1)
plot(rotorSPDS.Time, rotorSPDS.Data(:,1)); title('r1')
subplot(4,1,2)
plot(rotorSPDS.Time, rotorSPDS.Data(:,2)); title('r1')
subplot(4,1,3)
plot(rotorSPDS.Time, rotorSPDS.Data(:,3)); title('r1')
subplot(4,1,4)
plot(rotorSPDS.Time, rotorSPDS.Data(:,4)); title('r1')




